<%
const activePage = 'transactions';
const title = 'Transactions ‚Äì ExpenseIQ';
function inr(amount) {
  return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(amount || 0);
}
const urlParams = new URLSearchParams ? '' : '';
const successMsg = typeof filters !== 'undefined' ? null : null;
%>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css"/>
</head>
<body>
<div class="app-wrapper">
  <%- include('partials/sidebar') %>
  <main class="main-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Transactions</h1>
        <p class="page-subtitle">Track your income and expenses</p>
      </div>
      <button class="btn btn-primary" onclick="openModal('addModal')">+ Add Transaction</button>
    </div>

    <!-- Alert from redirect -->
    <div id="flashMsg" style="display:none" class="alert"></div>

    <!-- Filters -->
    <div class="card filter-card">
      <form method="GET" action="/transactions" class="filter-form">
        <div class="form-group">
          <label>Month</label>
          <select name="month">
            <% months.forEach((m, i) => { %>
              <option value="<%= i+1 %>" <%= filters.month === i+1 ? 'selected' : '' %>><%= m %></option>
            <% }) %>
          </select>
        </div>
        <div class="form-group">
          <label>Year</label>
          <select name="year">
            <% for(let y = currentYear; y >= currentYear - 3; y--) { %>
              <option value="<%= y %>" <%= filters.year === y ? 'selected' : '' %>><%= y %></option>
            <% } %>
          </select>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select name="category">
            <option value="">All Categories</option>
            <% categories.forEach(c => { %>
              <option value="<%= c.id %>" <%= filters.categoryId == c.id ? 'selected' : '' %>><%= c.name %> (<%= c.type %>)</option>
            <% }) %>
          </select>
        </div>
        <button type="submit" class="btn btn-outline">Filter</button>
        <a href="/transactions/export?month=<%= filters.month %>&year=<%= filters.year %>" class="btn btn-ghost">‚¨á Export CSV</a>
      </form>
    </div>

    <!-- Transaction Table -->
    <div class="card">
      <div class="card-body p0">
        <% if (transactions.length === 0) { %>
          <div class="empty-state padded">
            <p>No transactions found for this period</p>
            <button class="btn btn-primary" onclick="openModal('addModal')">Add Transaction</button>
          </div>
        <% } else { %>
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Description</th>
                <th>Type</th>
                <th class="text-right">Amount</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% transactions.forEach(t => { %>
              <tr>
                <td><%= new Date(t.transaction_date).toLocaleDateString('en-IN', {day:'numeric',month:'short',year:'numeric'}) %></td>
                <td><span class="badge badge-<%= t.category_type %>"><%= t.category_name %></span></td>
                <td class="desc-cell"><%= t.description || '‚Äî' %></td>
                <td><span class="type-pill <%= t.category_type %>"><%= t.category_type %></span></td>
                <td class="text-right <% if(t.category_type==='income'){%>income-text<%}else{%>expense-text<%}%>">
                  <%= t.category_type === 'income' ? '+' : '-' %><%= inr(t.amount) %>
                </td>
                <td class="text-center">
                  <button class="btn-icon" onclick="editTransaction(<%- JSON.stringify(t) %>)" title="Edit">‚úèÔ∏è</button>
                  <button class="btn-icon danger" onclick="deleteTransaction('<%= t.id %>')" title="Delete">üóëÔ∏è</button>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </div>
    </div>
  </main>
</div>

<!-- Add Modal -->
<div id="addModal" class="modal-overlay" style="display:none">
  <div class="modal">
    <div class="modal-header">
      <h3>Add Transaction</h3>
      <button class="modal-close" onclick="closeModal('addModal')">‚úï</button>
    </div>
    <form method="POST" action="/transactions" class="modal-form">
      <div class="form-group">
        <label>Category *</label>
        <select name="category_id" required>
          <option value="">Select category</option>
          <optgroup label="Income">
            <% categories.filter(c => c.type === 'income').forEach(c => { %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% }) %>
          </optgroup>
          <optgroup label="Expense">
            <% categories.filter(c => c.type === 'expense').forEach(c => { %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% }) %>
          </optgroup>
        </select>
      </div>
      <div class="form-group">
        <label>Amount (‚Çπ) *</label>
        <input type="number" name="amount" min="0.01" step="0.01" placeholder="e.g. 5000" required/>
      </div>
      <div class="form-group">
        <label>Date *</label>
        <input type="date" name="transaction_date" value="<%= new Date().toISOString().split('T')[0] %>" required/>
      </div>
      <div class="form-group">
        <label>Description</label>
        <input type="text" name="description" placeholder="Optional note"/>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" onclick="closeModal('addModal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Transaction</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-overlay" style="display:none">
  <div class="modal">
    <div class="modal-header">
      <h3>Edit Transaction</h3>
      <button class="modal-close" onclick="closeModal('editModal')">‚úï</button>
    </div>
    <form id="editForm" class="modal-form">
      <input type="hidden" id="editId"/>
      <div class="form-group">
        <label>Category *</label>
        <select id="editCategory" required>
          <optgroup label="Income">
            <% categories.filter(c => c.type === 'income').forEach(c => { %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% }) %>
          </optgroup>
          <optgroup label="Expense">
            <% categories.filter(c => c.type === 'expense').forEach(c => { %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% }) %>
          </optgroup>
        </select>
      </div>
      <div class="form-group">
        <label>Amount (‚Çπ) *</label>
        <input type="number" id="editAmount" min="0.01" step="0.01" required/>
      </div>
      <div class="form-group">
        <label>Date *</label>
        <input type="date" id="editDate" required/>
      </div>
      <div class="form-group">
        <label>Description</label>
        <input type="text" id="editDesc" placeholder="Optional note"/>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" onclick="closeModal('editModal')">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
// Handle flash messages from URL
const params = new URLSearchParams(window.location.search);
if (params.get('success')) showFlash(params.get('success'), 'success');
if (params.get('error')) showFlash(params.get('error'), 'error');

function showFlash(msg, type) {
  const el = document.getElementById('flashMsg');
  el.textContent = msg;
  el.className = 'alert alert-' + type;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}

function openModal(id) { document.getElementById(id).style.display = 'flex'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function editTransaction(t) {
  document.getElementById('editId').value = t.id;
  document.getElementById('editCategory').value = t.category_id;
  document.getElementById('editAmount').value = t.amount;
  document.getElementById('editDate').value = new Date(t.transaction_date).toISOString().split('T')[0];
  document.getElementById('editDesc').value = t.description || '';
  openModal('editModal');
}

async function saveEdit() {
  const id = document.getElementById('editId').value;
  const body = {
    category_id: document.getElementById('editCategory').value,
    amount: document.getElementById('editAmount').value,
    transaction_date: document.getElementById('editDate').value,
    description: document.getElementById('editDesc').value,
  };
  try {
    const res = await fetch('/transactions/' + id, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (data.success) {
      closeModal('editModal');
      location.reload();
    } else {
      alert(data.error || 'Failed to update');
    }
  } catch(e) {
    alert('Network error');
  }
}

async function deleteTransaction(id) {
  if (!confirm('Delete this transaction?')) return;
  try {
    const res = await fetch('/transactions/' + id, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) location.reload();
    else alert(data.error || 'Failed to delete');
  } catch(e) {
    alert('Network error');
  }
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.style.display = 'none'; });
});
</script>
</body>
</html>
